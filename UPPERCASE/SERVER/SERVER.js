global.CONNS=CONNS=OBJECT({init:function(t,e,o){"use strict";var a,r=t.socketPack,n={};o.addRoomFunc=a=function(t,e){void 0===n[t]&&(n[t]=[]),n[t].push(e)},r.on("connection",function(t){var e,o=t.handshake.headers["x-forwarded-for"],a={},r={},i={},d={};void 0===o&&(o=t.handshake.address.address),t.addListener("disconnect",function(){EACH(d,function(t){EACH(t,function(t){t()})})}),t.addListener("__ENTER_ROOM",function(c){EACH(n,function(n,s){var v,u="",f=s,E={};return v=function(t){var e,o;return-1!==f.indexOf("{")&&-1!==f.indexOf("}")&&(o=f.substring(0,f.indexOf("{")),u+"/"===o)?(e=f.substring(f.indexOf("{")+1,f.indexOf("}")),f=o+t+f.substring(f.indexOf("}")+1),{name:e,value:t}):void 0},EACH(c.split("/"),function(t,e){var o=v(t);return void 0!==o&&(E[o.name]=o.value),0===e?u=t:u+="/"+t,u===f?!1:void 0}),c===f?(void 0===r[c]?(a[c]=[],d[c]=[],t.join(c),EACH(n,function(r){a[c].push(r(c,t,o,t.handshake.headers,E,function(t){e=t},function(){return e},function(){e=void 0},i,d[c]))}),r[c]=1):r[c]+=1,!1):void 0})}),t.addListener("__EXIT_ROOM",function(e){r[e]-=1,0===r[e]&&(EACH(a[e],function(t){t.removeAllListeners()}),t.leave(e),delete a[e],delete r[e],delete d[e])})})}}),FOR_BOX(function(t){"use strict";t.DB=CLASS({init:function(e,o,a,r){var n,i,d,c,s,v,u,f,E,m,D,h,S,R,A,l,C,O=UPPERCASE.MODULE("mongolian").ObjectId;SERVER_CONFIG.isNotUsingDB===!0?(a.createData=m=function(){},a.getData=D=function(){},a.updateData=h=function(){},a.removeData=S=function(){},a.findData=R=function(){},a.findDataSet=A=function(){},a.countDataSet=l=function(){},a.checkIsExists=C=function(){}):(n=UPPERCASE.db.collection(t.boxName+"."+r),i=UPPERCASE.db.collection(t.boxName+"."+r+"_backup"),d=UPPERCASE.db.collection(t.boxName+"."+r+"_error"),c=function(t){return new O(t)},s=function(t){return void 0!==t._id&&(t.id=t._id.toString()),delete t._id,delete t.__IS_ENABLED,t},v=function(t){EACH(t,function(e,o){e===TO_DELETE?REMOVE_AT({data:t,key:o}):(CHECK_IS_DATA(e)===!0||CHECK_IS_ARRAY(e)===!0)&&v(e)})},u=function(t){void 0!==t.id&&(CHECK_IS_DATA(t.id)===!0?(EACH(t.id,function(e,o){CHECK_IS_DATA(e)===!0||CHECK_IS_ARRAY(e)===!0?EACH(e,function(t,o){e[o]=c(t)}):t.id[o]=c(e)}),t._id=t.id):t._id=c(id),delete t.id),t.__IS_ENABLED=!0,EACH(t,function(e,o){void 0===e&&delete t[o]})},f=function(t){var e=t.method,o=t.data,a=new Date,r={method:e,time:a,data:o};i.save(r),CONFIG.isDevMode===!0&&console.log("[DB SAVED]",r)},E=function(t){t.time=new Date,d.save(t),CONFIG.isDevMode===!0&&console.log("[DB ERROR]",t)},a.createData=m=function(t,e){var o;try{t.__IS_ENABLED=!0,t.createTime=new Date,v(t),n.save(t,function(a,r){null===a?(f({method:"createData",data:r}),s(r),e(void 0,r)):(o=a.toString(),E({method:"createData",data:t,errorMsg:o}),e(o))})}catch(a){o=a.toString(),E({method:"createData",data:t,errorMsg:o}),e(o)}},a.getData=D=function(t,e){var o,a;try{o={_id:c(t),__IS_ENABLED:!0},n.findOne(o,function(o,r){null===o?(void 0!==r&&s(r),e(void 0,r)):(a=o.toString(),E({method:"getData",id:t,errorMsg:a}),e(a))})}catch(r){a=r.toString(),E({method:"getData",id:t,errorMsg:a}),e(a)}},a.updateData=h=function(t,e){var o,a,r=t.id;try{o={_id:c(r),__IS_ENABLED:!0},n.findOne(o,function(o,r){delete t.id,null===o?void 0===r?e():(EACH(r,function(e,o){(void 0===t[o]||"_id"===o||"__IS_ENABLED"===o||"createTime"===o)&&(t[o]=e)}),v(t),t.lastUpdateTime=new Date,n.save(t,function(o,r){null===o?(f({method:"updateData",data:r}),s(r),e(void 0,r)):(a=o.toString(),E({method:"updateData",data:t,errorMsg:a}),e(a))})):(a=o.toString(),E({method:"updateData",data:t,errorMsg:a}),e(a))})}catch(i){a=i.toString(),E({method:"updateData",data:t,errorMsg:a}),e(a)}},a.removeData=S=function(t,e){var o,a;try{o={_id:c(t),__IS_ENABLED:!0},n.findOne(o,function(o,r){null===o?void 0===r?e():(r.__IS_ENABLED=!1,r.removeTime=new Date,n.save(r,function(o,r){null===o?(f({method:"removeData",data:r}),s(r),e(void 0,r)):(a=o.toString(),E({method:"removeData",id:t,errorMsg:a}),e(a))})):(a=o.toString(),E({method:"removeData",id:t,errorMsg:a}),e(a))})}catch(r){a=r.toString(),E({method:"removeData",id:t,errorMsg:a}),e(a)}},a.findData=R=function(t,e){var o;void 0!==t&&void 0===e&&(e=t),void 0===t&&(t={});try{u(t),n.findOne(t,function(a,r){null===a?(void 0!==r&&s(r),e(void 0,r)):(o=a.toString(),E({method:"findData",filter:t,errorMsg:o}),e(o))})}catch(a){o=a.toString(),E({method:"findData",filter:t,errorMsg:o}),e(o)}},a.findDataSet=A=function(t,e){var o,a,r=void 0===t?void 0:t.filter,i=void 0===t?void 0:t.sort,d=void 0===t?void 0:t.start,c=void 0===t||void 0===t.count?void 0:parseInt(t.count,10),v=void 0===t||void 0===t.isFindAll?void 0:parseInt(t.isFindAll,10);void 0!==t&&void 0===e&&(e=t);try{void 0===r&&(r={}),void 0===i&&(i={}),void 0===d&&(d=0),v!==!0&&(void 0===c||c>SERVER_CONFIG.maxDataCount||isNaN(c)===!0?c=SERVER_CONFIG.maxDataCount:1>c&&(c=1)),u(r),a=function(a,r){null===a?(void 0!==r&&EACH(r,function(t){s(t)}),e(void 0,r)):(o=a.toString(),E({method:"findDataSet",params:t,errorMsg:o}),e(o))},v===!0?n.find(r).sort(i).skip(d).toArray(a):n.find(r).sort(i).skip(d).limit(c).toArray(a)}catch(f){o=f.toString(),E({method:"findDataSet",params:t,errorMsg:o}),e(o)}},a.countDataSet=l=function(t,e){var o;void 0!==t&&void 0===e&&(e=t),void 0===t&&(t={});try{u(t),n.find(t).count(function(a,r){null===a?e(void 0,r):(o=a.toString(),E({method:"countDataSet",filter:t,errorMsg:o}),e(o))})}catch(a){o=a.toString(),E({method:"countDataSet",filter:t,errorMsg:o}),e(o)}},a.checkIsExists=C=function(t,e){var o;void 0!==t&&void 0===e&&(e=t),void 0===t&&(t={});try{u(t),n.find(t).count(function(a,r){null===a?e(void 0,void 0!==r&&r>0):(o=a.toString(),E({method:"checkIsExists",filter:t,errorMsg:o}),e(o))})}catch(a){o=a.toString(),E({method:"checkIsExists",filter:t,errorMsg:o}),e(o)}})}})}),FOR_BOX(function(t){"use strict";t.LOG_DB=CLASS({init:function(e,o,a,r){var n,i;SERVER_CONFIG.isNotUsingDB===!0?a.log=i=function(){}:(n=UPPERCASE.db.collection(t.boxName+"."+r),a.log=i=function(t){t.time=new Date,n.save(t)})}})}),FOR_BOX(function(t){"use strict";OVERRIDE(t.MODEL,function(){t.MODEL=CLASS({init:function(e,o,a,r){var n,i,d,c,s,v,u,f,E,m,D,h,S,R,A,l,C,O,g,_,M,N,p=r.name,b=void 0===r.propertyNamesForNewEvent?[]:r.propertyNamesForNewEvent,I=r.config,H=t.DB(p);void 0!==I&&(n=I.create,i=I.getData,d=I.update,c=I.remove,s=I.findData,v=I.findDataSet,u=I.countDataSet,f=I.checkIsExists,void 0!==n&&(E=n.valid),void 0!==d&&(m=d.valid)),o.getCreateValid=D=function(){return E},o.getUpdateValid=h=function(){return m},t.ROOM(p+"/create"),EACH(b,function(e){t.ROOM(p+"/"+e+"/{value}/create")}),t.ROOM(p+"/remove"),EACH(b,function(e){t.ROOM(p+"/"+e+"/{value}/remove")}),t.ROOM(p,function(e){n!==!1&&e.on("create",function(a,r){var n,i=void 0===E?void 0:E.check({data:a});void 0!==i&&i.checkHasError()===!0?r({hasError:!0,errors:i.getErrors()}):(n=function(){H.createData(a,function(a,n){void 0!==a?r({hasError:!0,errorMsg:a}):(void 0!==o.afterCreate&&o.afterCreate(n),void 0!==o.afterCreateRoom&&o.afterCreateRoom({savedData:n,room:e}),t.ROOMS(p+"/create").broadcast({methodName:"create",data:n}),EACH(b,function(e){var o=n[e];t.ROOMS(p+"/"+e+"/"+o+"/create").broadcast({methodName:"create",data:n})}),r({hasError:!1,savedData:n}))})},void 0===o.beforeCreateRoom?void 0!==o.beforeCreate?o.beforeCreate(a,{ret:r,proc:n})!==!1&&n():n():o.beforeCreateRoom({data:a,room:e},{ret:r,proc:n}))}),i!==!1&&e.on("getData",A),s!==!1&&e.on("findData",O),v!==!1&&e.on("findDataSet",function(t,e){delete t.isFindAll,g(t,e)}),u!==!1&&e.on("countDataSet",_),f!==!1&&e.on("checkIsExists",M)}),t.ROOM(p+"/{id}",function(e,a){var r=a.id;d!==!1&&e.on("update",function(t,a){var n,i=void 0===m?void 0:m.check({data:t,isExceptUndefined:!0});t.id=r,void 0!==i&&i.checkHasError()===!0?a({hasError:!0,errors:i.getErrors()}):(n=function(){H.updateData(t,function(t,r){void 0!==t?a({hasError:!0,errorMsg:t}):(void 0!==r&&(void 0!==o.afterUpdate&&o.afterUpdate(r),void 0!==o.afterUpdateRoom&&o.afterUpdateRoom({savedData:r,room:e}),e.broadcast({methodName:"update",data:r})),a({hasError:!1,savedData:r}))})},void 0===o.beforeUpdateRoom?void 0!==o.beforeUpdate?o.beforeUpdate(t,{ret:a,proc:n})!==!1&&n():n():o.beforeUpdateRoom({data:t,room:e},{ret:a,proc:n})!==!1&&n())}),c!==!1&&e.on("remove",function(a,r){var n;n=function(){H.removeData(a,function(a,n){void 0!==a?r({hasError:!0,errorMsg:a}):(void 0!==n&&(void 0!==o.afterRemove&&o.afterRemove(n),void 0!==o.afterRemoveRoom&&o.afterRemoveRoom({savedData:n,room:e}),e.broadcast({methodName:"remove",data:n}),EACH(b,function(e){var o=n[e];t.ROOMS(p+"/"+e+"/"+o+"/remove").broadcast({methodName:"remove",data:n})})),r({hasError:!1,savedData:n}))})},void 0===o.beforeRemoveRoom?void 0!==o.beforeRemove?o.beforeRemove(a,{ret:r,proc:n})!==!1&&n():n():o.beforeRemoveRoom({id:a,room:e},{ret:r,proc:n})!==!1&&n()})}),o.getDB=S=function(){return H},n!==!1&&(a.create=R=function(e,a){var r,n=void 0===E?void 0:E.check({data:e});void 0!==n&&n.checkHasError()===!0?void 0!==a&&a({hasError:!0,errors:n.getErrors()}):(r=function(){H.createData(e,function(e,r){void 0!==e?void 0!==a&&a({hasError:!0,errorMsg:e}):(void 0!==o.afterCreate&&o.afterCreate(r),t.ROOMS(p+"/create").broadcast({methodName:"create",data:r}),EACH(b,function(e){var o=r[e];t.ROOMS(p+"/"+e+"/"+o+"/create").broadcast({methodName:"create",data:r})}),void 0!==a&&a({hasError:!1,savedData:r}))})},void 0!==o.beforeCreate?o.beforeCreate(e,{ret:a,proc:r})!==!1&&r():r())}),i!==!1&&(a.getData=A=function(t,e){H.getData(t,function(t,a){void 0!==t?void 0!==e&&e({hasError:!0,errorMsg:t}):(void 0===o.getData||o.getData(a,e)!==!1)&&void 0!==e&&e({hasError:!1,savedData:a})})}),d!==!1&&(a.update=l=function(e,a){var r,n=void 0===m?void 0:m.check({data:e,isExceptUndefined:!0});void 0!==n&&n.checkHasError()===!0?void 0!==a&&a({hasError:!0,errors:n.getErrors()}):(r=function(){H.updateData(e,function(r,n){void 0!==r?void 0!==a&&a({hasError:!0,errorMsg:r}):(void 0!==n&&(void 0!==o.afterUpdate&&o.afterUpdate(n),t.ROOMS(p+"/"+e.id).broadcast({methodName:"update",data:n})),void 0!==a&&a({hasError:!1,savedData:n}))})},void 0!==o.beforeUpdate?o.beforeUpdate(e,{ret:a,proc:r})!==!1&&r():r())}),c!==!1&&(a.remove=C=function(e,a){var r;r=function(){H.removeData(e,function(e,r){void 0!==e?void 0!==a&&a({hasError:!0,errorMsg:e}):(void 0!==r&&(void 0!==o.afterRemove&&o.afterRemove(r),t.ROOMS(p+"/"+r.id).broadcast({methodName:"remove",data:r}),EACH(b,function(e){var o=r[e];t.ROOMS(p+"/"+e+"/"+o+"/remove").broadcast({methodName:"remove",data:r})})),void 0!==a&&a({hasError:!1,savedData:r}))})},void 0!==o.beforeRemove?o.beforeRemove(e,{ret:a,proc:r})!==!1&&r():r()}),s!==!1&&(a.findData=O=function(t,e){H.findData(t,function(t,a){void 0!==t?void 0!==e&&e({hasError:!0,errorMsg:t}):(void 0===o.findData||o.findData(a,e)!==!1)&&void 0!==e&&e({hasError:!1,savedData:a})})}),v!==!1&&(a.findDataSet=g=function(t,e){H.findDataSet(t,function(t,a){void 0!==t?void 0!==e&&e({hasError:!0,errorMsg:t}):(void 0===o.findDataSet||o.findDataSet(a,e)!==!1)&&void 0!==e&&e({hasError:!1,savedDataSet:a})})}),u!==!1&&(a.countDataSet=_=function(t,e){H.countDataSet(t,function(t,a){void 0!==t?void 0!==e&&e({hasError:!0,errorMsg:t}):(void 0===o.countDataSet||o.countDataSet(a,e)!==!1)&&void 0!==e&&e({hasError:!1,count:a})})}),f!==!1&&(a.checkIsExists=M=function(t,e){H.checkIsExists(t,function(t,a){void 0!==t?void 0!==e&&e({hasError:!0,errorMsg:t}):(void 0===o.checkIsExists||o.checkIsExists(a,e)!==!1)&&void 0!==e&&e({hasError:!1,isExists:a})})}),o.getName=N=function(){return p}}})})}),FOR_BOX(function(t){"use strict";t.MODULE=METHOD({run:function(e,o){var a=__dirname+"/../..";return require(a+"/"+t.boxName+"/SERVER/node_modules/"+o)}})}),FOR_BOX(function(t){"use strict";t.ROOM=METHOD({run:function(e,o,a){CONNS.addRoomFunc(t.boxName+"/"+o,function(t,e,o,r,n,i,d,c,s,v){var u=OBJECT({init:function(a,n,u){var f,E,m,D,h,S,R,A,l,C,O,g,_,M,N={};u.on=f=function(o,a){var r,n=t+"/"+o;r=function(t){var o=CHECK_IS_DATA(t.data)===!0?UNPACK_DATA(t.data):t.data,r=t.instantListenerName;a(o,function(t){e.emit(r,CHECK_IS_DATA(t)===!0?PACK_DATA(t):t)})},e.addListener(n,r),void 0===N[n]&&(N[n]=[]),N[n].push(r)},u.broadcast=E=function(e){var o=e.methodName,a=CHECK_IS_DATA(e.data)===!0?PACK_DATA(e.data):e.data,r=t+"/"+o;CONNS.type.socketPack["in"](t).emit(r,a)},u.broadcastExceptSender=m=function(o){var a=o.methodName,r=CHECK_IS_DATA(o.data)===!0?PACK_DATA(o.data):o.data,n=t+"/"+a;e.broadcast.to(t).emit(n,r)},u.removeAllListeners=D=function(){EACH(N,function(t,o){EACH(t,function(t){e.removeListener(o,t)})}),N.length=0},u.setAuthKey=h=function(t){i(t)},u.getAuthKey=S=function(){return d()},u.removeAuthKey=R=function(){c()},u.addRole=A=function(t){s[t]=!0},u.checkRole=l=function(t){return s[t]===!0},u.removeRole=C=function(t){REMOVE_AT({data:s,key:t})},u.removeAllRoles=O=function(){EACH(s,function(t,e){REMOVE_AT({data:s,key:e})})},u.addDisconnectListener=g=function(t){v.push(t)},u.getIp=_=function(){return o},u.getHeaders=M=function(){return r}}});return void 0!==a&&a(u,n),u})}})}),FOR_BOX(function(t){"use strict";t.ROOMS=CLASS({init:function(e,o,a,r){var n,i=t.boxName+"/"+r;a.broadcast=n=function(t){var e=t.methodName,o=CHECK_IS_DATA(t.data)===!0?PACK_DATA(t.data):t.data,a=i+"/"+e;CONNS.type.socketPack["in"](i).emit(a,o)}}})}),global.SERVER_CONFIG=SERVER_CONFIG={dbName:"UPPERCASE-testdb",dbUsername:"test",dbPassword:"test",isNotRequiringDBAuth:!1,maxDataCount:1e3,securedUsername:"test",securedPassword:"test",authedPageUrl:"/UPPERCASE/R/AUTHED.html",errorPageUrl:"/UPPERCASE/R/ERROR.html"},global.SHA1=SHA1=METHOD({run:function(t,e){"use strict";var o=e.key,a=e.password,r=require("crypto");return r.createHmac("sha1",o).update(a).digest("hex")}}),global.TIME_SYNC=TIME_SYNC=OBJECT({init:function(){"use strict";UPPERCASE.ROOM("timeSync",function(t){t.on("sync",function(t,e){var o=new Date,a=t.now;e({diff:a-o})})})}});